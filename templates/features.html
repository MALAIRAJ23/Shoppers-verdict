{% extends 'base.html' %}

{% block title %}AI Shopping Labs - Features{% endblock %}

{% block content %}
<section class="labs-hero text-center py-5">
  <div class="container">
    <h1 class="display-5 fw-bold text-white">AI Shopping Labs</h1>
    <p class="lead text-white-50 mb-0">Experiment with advanced tools that power Shopper's Verdict.</p>
  </div>
</section>

<div class="container py-5">
  <div class="row g-4">
    <!-- Card 1: Aspect Explorer -->
    <div class="col-lg-4">
      <a class="glass-card h-100 text-decoration-none text-reset feature-link" href="/features?open=aspects">
        <div class="card-inner">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <h5 class="mb-1"><i class="bi bi-compass me-2"></i>Aspect Explorer</h5>
              <p class="text-muted small mb-0">Discover what customers talk about and how they feel.</p>
            </div>
            <span class="btn btn-outline-light btn-sm">Open</span>
          </div>
        </div>
      </a>
    </div>

    <!-- Card 2: Price Insight Simulator -->
    <div class="col-lg-4">
      <a class="glass-card h-100 text-decoration-none text-reset feature-link" href="/features?open=price">
        <div class="card-inner">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <h5 class="mb-1"><i class="bi bi-graph-up-arrow me-2"></i>Price Insight Simulator</h5>
              <p class="text-muted small mb-0">Track trends, filter ranges, and reveal pricing signals.</p>
            </div>
            <span class="btn btn-outline-light btn-sm">Open</span>
          </div>
        </div>
      </a>
    </div>

    <!-- Card 3: Verdict Composer -->
    <div class="col-lg-4">
      <a class="glass-card h-100 text-decoration-none text-reset feature-link" href="/features?open=verdict">
        <div class="card-inner">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <h5 class="mb-1"><i class="bi bi-magic me-2"></i>Verdict Composer</h5>
              <p class="text-muted small mb-0">Tune weights and generate a personalized voice verdict.</p>
            </div>
            <span class="btn btn-outline-light btn-sm">Open</span>
          </div>
        </div>
      </a>
    </div>
  </div>

  <hr class="my-5">

  <!-- Panels -->
  <div id="panel-aspects" class="card shadow-sm mb-4 d-none">
    <div class="card-header">Aspect Explorer</div>
    <div class="card-body">
      <label class="form-label">Product URL</label>
      <div class="input-group mb-3">
        <input id="urlAspects" type="url" class="form-control" placeholder="https://www.flipkart.com/... or https://www.amazon.in/...">
        <button id="btnFetchAspects" class="btn btn-primary">Fetch</button>
      </div>
      <div id="statusAspects"></div>
      <div id="aspectsBody" class="d-none">
        <div class="d-flex flex-wrap gap-2" id="aspectChips"></div>
        <div class="mt-3">
          <h6 class="mb-2">Supporting Sentences</h6>
          <ul id="aspectSentences" class="list-group small"></ul>
        </div>
      </div>
    </div>
  </div>

  <div id="panel-price" class="card shadow-sm mb-4 d-none">
    <div class="card-header">Price Insight Simulator</div>
    <div class="card-body">
      <label class="form-label">Product URL</label>
      <div class="input-group mb-3">
        <input id="urlPrice" type="url" class="form-control" placeholder="https://...">
        <button id="btnFetchPrice" class="btn btn-primary">Fetch</button>
      </div>
      <div id="statusPrice"></div>
      <div id="priceBody" class="d-none">
        <div class="row g-3 align-items-end">
          <div class="col-6">
            <label class="form-label small">From</label>
            <input id="fromDate" type="date" class="form-control form-control-sm">
          </div>
          <div class="col-6">
            <label class="form-label small">To</label>
            <input id="toDate" type="date" class="form-control form-control-sm">
          </div>
        </div>
        <div class="d-flex gap-2 mt-2">
          <button id="btnApplyRange" class="btn btn-outline-primary btn-sm">Apply Range</button>
          <button id="btnResetRange" class="btn btn-outline-secondary btn-sm">Reset</button>
        </div>
        <div class="row g-3 mt-3">
          <div class="col-6 col-md-3">
            <div class="metric">
              <div class="metric-label">Latest</div>
              <div class="metric-value" id="mLatest">—</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric">
              <div class="metric-label">Min</div>
              <div class="metric-value" id="mMin">—</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric">
              <div class="metric-label">Max</div>
              <div class="metric-value" id="mMax">—</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric">
              <div class="metric-label">Volatility</div>
              <div class="metric-value" id="mVol">—</div>
            </div>
          </div>
        </div>
        <canvas id="priceChartPreview" height="120" class="mt-3"></canvas>
      </div>
    </div>
  </div>

  <div id="panel-verdict" class="card shadow-sm mb-4 d-none">
    <div class="card-header">Verdict Composer</div>
    <div class="card-body">
      <ul class="nav nav-pills small" id="inputMode" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-mode="scraped" type="button">Use Last Scrape</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-mode="custom" type="button">Custom Text</button>
        </li>
      </ul>

      <div id="customTextBox" class="mt-3 d-none">
        <label class="form-label">Enter one review per line</label>
        <textarea id="customTexts" class="form-control" rows="5" placeholder="Great battery life...\nSpeakers are weak..."></textarea>
      </div>

      <div class="row mt-3 g-3">
        <div class="col-12">
          <label class="form-label">Review Weight vs Aspect Weight</label>
          <input type="range" id="weightSlider" class="form-range" min="0" max="100" step="5" value="70">
          <div class="d-flex justify-content-between small">
            <span>Reviews: <span id="wReviews">70</span>%</span>
            <span>Aspects: <span id="wAspects">30</span>%</span>
          </div>
        </div>
        <div class="col-12">
          <label class="form-label">Pros/Cons Threshold</label>
          <input type="range" id="threshSlider" class="form-range" min="0" max="20" step="1" value="5">
          <div class="small text-muted">Higher values demand stronger sentiment to qualify as a pro/cons.</div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-2">
        <button id="btnCompose" class="btn btn-primary">Compose Verdict</button>
        <button id="btnSpeak" class="btn btn-outline-primary"><i class="bi bi-volume-up"></i></button>
      </div>

      <div id="composeStatus" class="mt-3"></div>
      <div id="composeResults" class="mt-3 d-none">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Score</h6>
              <span class="badge bg-primary" id="cScore">—</span>
            </div>
            <hr>
            <div class="row">
              <div class="col-6">
                <h6>Pros</h6>
                <ul id="cPros" class="list-group list-group-flush small"></ul>
              </div>
              <div class="col-6">
                <h6>Cons</h6>
                <ul id="cCons" class="list-group list-group-flush small"></ul>
              </div>
            </div>
            <hr>
            <p class="mb-0 small text-muted">Verdict</p>
            <p id="cVerdict" class="mb-0"></p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
/* Enhanced Features Page Styling */
.labs-hero { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    position: relative;
    overflow: hidden;
}

.labs-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    pointer-events: none;
}

.labs-hero .container {
    position: relative;
    z-index: 2;
}

/* Enhanced Glass Card */
.glass-card { 
    position: relative; 
    border-radius: 20px; 
    background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(255,255,255,0.8));
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255,255,255,0.3); 
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15),
                0 1px 0 rgba(255, 255, 255, 0.5) inset;
    overflow: hidden; 
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
    display: block;
    text-decoration: none;
    transform: translateY(0);
}

.glass-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.glass-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.25),
                0 1px 0 rgba(255, 255, 255, 0.6) inset;
    text-decoration: none;
    color: inherit;
}

.glass-card:hover::before {
    opacity: 1;
}

.glass-card .card-inner { 
    padding: 2rem;
    position: relative;
    z-index: 2;
}

.glass-card h5 {
    color: #2d3748;
    font-weight: 700;
    font-size: 1.25rem;
    margin-bottom: 0.75rem;
    letter-spacing: -0.01em;
}

.glass-card p {
    color: #4a5568;
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.glass-card .btn {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    border: 1px solid rgba(102, 126, 234, 0.2);
    font-size: 0.875rem;
    font-weight: 600;
    padding: 8px 16px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.glass-card:hover .btn {
    background: rgba(102, 126, 234, 0.15);
    border-color: rgba(102, 126, 234, 0.3);
    transform: translateX(4px);
}

/* Enhanced Feature Panels */
.card {
    border-radius: 16px;
    border: 1px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.card:not(.d-none) {
    animation: slideInUp 0.6s ease-out;
}

.card-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 16px 16px 0 0;
    padding: 1.25rem 1.5rem;
    font-weight: 700;
    font-size: 1.1rem;
    border: none;
    position: relative;
    overflow: hidden;
}

.card-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    transform: translate(30px, -30px);
}

.card-body {
    padding: 2rem;
}

/* Form Controls */
.form-control {
    border-radius: 12px;
    border: 1px solid rgba(226, 232, 240, 0.8);
    padding: 12px 16px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: white;
}

/* Button Enhancements */
.btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-weight: 600;
    box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    background: linear-gradient(135deg, #5a6fd8, #6b5b95);
}

.btn-outline-primary {
    border-color: #667eea;
    color: #667eea;
    border-radius: 12px;
    padding: 8px 16px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-outline-primary:hover {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-color: transparent;
    transform: translateY(-1px);
}

.btn-outline-secondary {
    border-color: #718096;
    color: #718096;
    border-radius: 12px;
    padding: 8px 16px;
    font-weight: 500;
}

.btn-outline-secondary:hover {
    background: #718096;
    border-color: #718096;
    color: white;
}

/* Metrics Styling */
.metric { 
    background: linear-gradient(145deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
    border: 1px solid rgba(102, 126, 234, 0.1); 
    border-radius: 12px; 
    padding: 1rem 1.25rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.metric::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    transition: width 0.3s ease;
}

.metric:hover::before {
    width: 8px;
}

.metric-label { 
    font-size: 0.8rem; 
    color: #718096;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-value { 
    font-weight: 800;
    font-size: 1.5rem;
    color: #2d3748;
    margin-top: 0.25rem;
}

/* Aspect Chips */
.aspect-chip { 
    border-radius: 20px; 
    padding: 8px 16px; 
    color: white; 
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer; 
    user-select: none; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin: 4px;
    position: relative;
    overflow: hidden;
}

.aspect-chip::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.6s ease;
}

.aspect-chip:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.aspect-chip:hover::before {
    left: 100%;
}

.aspect-chip:active {
    transform: translateY(0) scale(1.02);
}

/* Alert Styling */
.alert {
    border-radius: 12px;
    border: none;
    padding: 1rem 1.25rem;
    font-weight: 500;
    backdrop-filter: blur(10px);
}

.alert-info {
    background: linear-gradient(145deg, rgba(66, 153, 225, 0.1), rgba(66, 153, 225, 0.05));
    color: #2b6cb0;
    border-left: 4px solid #4299e1;
}

.alert-success {
    background: linear-gradient(145deg, rgba(72, 187, 120, 0.1), rgba(72, 187, 120, 0.05));
    color: #276749;
    border-left: 4px solid #48bb78;
}

.alert-warning {
    background: linear-gradient(145deg, rgba(237, 137, 54, 0.1), rgba(237, 137, 54, 0.05));
    color: #975a16;
    border-left: 4px solid #ed8936;
}

.alert-danger {
    background: linear-gradient(145deg, rgba(245, 101, 101, 0.1), rgba(245, 101, 101, 0.05));
    color: #c53030;
    border-left: 4px solid #f56565;
}

/* Loading States */
.d-none {
    display: none !important;
}

/* Smooth Scrolling */
html {
    scroll-behavior: smooth;
}

/* Focus States */
*:focus {
    outline: 2px solid rgba(102, 126, 234, 0.5);
    outline-offset: 2px;
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5a6fd8, #6b5b95);
}

/* Animation for panel appearance */
@keyframes slideInUp {
    0% {
        opacity: 0;
        transform: translateY(30px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
(() => {
  // Utility: show exactly one panel, scroll to it
  function showPanel(key) {
    const id = key === 'aspects' ? '#panel-aspects' : key === 'price' ? '#panel-price' : key === 'verdict' ? '#panel-verdict' : null;
    if (!id) return;
    document.querySelectorAll('#panel-aspects, #panel-price, #panel-verdict').forEach(el => el.classList.add('d-none'));
    const panel = document.querySelector(id);
    panel.classList.remove('d-none');
    setTimeout(() => panel.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
  }

  // Open requested panel based on URL param
  const params = new URLSearchParams(window.location.search);
  const open = params.get('open');
  if (open) showPanel(open);

  // Shared state
  let lastScrape = null; // { sample_reviews, price_history, reviews_count }

  // Helpers
  const colorForSent = (v) => {
    const clamped = Math.max(-1, Math.min(1, v || 0));
    const hue = (clamped + 1) * 60; // -1->0 red, 0->60 yellow, 1->120 green
    return `hsl(${hue}, 85%, 45%)`;
  };
  const toSentences = (text) => text.split(/(?<=[.!?])\s+/g).map(s => s.trim()).filter(Boolean);

  async function fetchPreview(url) {
    const res = await fetch('/api/scrape_preview', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'Scrape failed');
    lastScrape = { sample_reviews: data.sample_reviews || [], price_history: data.price_history || [], reviews_count: data.reviews_count || 0 };
    return lastScrape;
  }

  async function analyzeTexts(texts) {
    const res = await fetch('/api/analyze_text', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ texts }) });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'Analysis failed');
    return data.analysis || { overall_sentiment: {}, aspect_sentiments: {} };
  }

  // ========== Aspect Explorer ==========
  const urlAspects = document.getElementById('urlAspects');
  const btnFetchAspects = document.getElementById('btnFetchAspects');
  const statusAspects = document.getElementById('statusAspects');
  const aspectChips = document.getElementById('aspectChips');
  const aspectSentences = document.getElementById('aspectSentences');
  const aspectsBody = document.getElementById('aspectsBody');

  btnFetchAspects?.addEventListener('click', async () => {
    statusAspects.innerHTML = '<div class="alert alert-info">Fetching and analyzing...</div>';
    aspectChips.innerHTML = '';
    aspectSentences.innerHTML = '';
    aspectsBody.classList.add('d-none');
    try {
      const url = urlAspects.value.trim();
      if (!url) throw new Error('Please enter a product URL');
      const preview = await fetchPreview(url);
      const analysis = await analyzeTexts(preview.sample_reviews);
      const aspects = analysis.aspect_sentiments || {};
      const sorted = Object.entries(aspects).sort((a,b) => Math.abs(b[1]) - Math.abs(a[1]));
      if (sorted.length === 0) {
        statusAspects.innerHTML = '<div class="alert alert-warning">No aspects identified from the sampled reviews.</div>';
        return;
      }
      // Build chips
      sorted.forEach(([aspect, score]) => {
        const chip = document.createElement('span');
        chip.className = 'aspect-chip';
        chip.style.background = colorForSent(score);
        chip.innerText = `${aspect} (${score})`;
        chip.addEventListener('click', () => {
          const sents = (preview.sample_reviews || []).flatMap(toSentences);
          const lower = aspect.toLowerCase();
          const matches = sents.filter(s => s.toLowerCase().includes(lower)).slice(0, 10);
          aspectSentences.innerHTML = matches.map(s => `<li class="list-group-item">${s}</li>`).join('') || '<li class="list-group-item">No supporting sentences found.</li>';
        });
        aspectChips.appendChild(chip);
      });
      aspectsBody.classList.remove('d-none');
      statusAspects.innerHTML = `<div class="alert alert-success">Analyzed ${preview.reviews_count} reviews (sampled ${preview.sample_reviews.length}). Click a chip to see sentences.</div>`;
    } catch (e) {
      statusAspects.innerHTML = `<div class=\"alert alert-danger\">${e.message || 'Unexpected error'}</div>`;
    }
  });

  // ========== Price Insight Simulator ==========
  const urlPrice = document.getElementById('urlPrice');
  const btnFetchPrice = document.getElementById('btnFetchPrice');
  const statusPrice = document.getElementById('statusPrice');
  const priceBody = document.getElementById('priceBody');
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const btnApplyRange = document.getElementById('btnApplyRange');
  const btnResetRange = document.getElementById('btnResetRange');
  const mLatest = document.getElementById('mLatest');
  const mMin = document.getElementById('mMin');
  const mMax = document.getElementById('mMax');
  const mVol = document.getElementById('mVol');
  let priceChart;

  function computeMetrics(series) {
    if (!series.length) return { latest: '—', min: '—', max: '—', vol: '—' };
    const prices = series.map(p => p.price);
    const latest = series[series.length - 1].price;
    const min = Math.min(...prices), max = Math.max(...prices);
    const mean = prices.reduce((a,b)=>a+b,0)/prices.length;
    const variance = prices.reduce((a,b)=>a+Math.pow(b-mean,2),0)/prices.length;
    const std = Math.sqrt(variance);
    const vol = mean ? (std/mean*100).toFixed(2) + '%' : '—';
    return { latest, min, max, vol };
  }

  function drawPriceChart(series) {
    const ctx = document.getElementById('priceChartPreview').getContext('2d');
    if (priceChart) priceChart.destroy();
    priceChart = new Chart(ctx, {
      type: 'line',
      data: { labels: series.map(s => s.timestamp), datasets: [{ label: 'Price', data: series.map(s => s.price), borderColor: '#20c997', backgroundColor: 'transparent', tension: 0.15 }] },
      options: { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { title: { display: true, text: 'Price' } } } }
    });
  }

  function applyRange(series) {
    const from = fromDate.value ? new Date(fromDate.value) : null;
    const to = toDate.value ? new Date(toDate.value) : null;
    const filtered = series.filter(p => { const d = new Date(p.timestamp); if (from && d < from) return false; if (to && d > to) return false; return true; });
    const m = computeMetrics(filtered);
    mLatest.textContent = m.latest; mMin.textContent = m.min; mMax.textContent = m.max; mVol.textContent = m.vol;
    drawPriceChart(filtered);
  }

  btnFetchPrice?.addEventListener('click', async () => {
    statusPrice.innerHTML = '<div class="alert alert-info">Fetching price history...</div>';
    priceBody.classList.add('d-none');
    try {
      const url = urlPrice.value.trim();
      if (!url) throw new Error('Please enter a product URL');
      const preview = await fetchPreview(url);
      const hist = preview.price_history || [];
      if (!hist.length) { statusPrice.innerHTML = '<div class="alert alert-warning">No price history available yet. Trigger analysis a few times to build history.</div>'; return; }
      const first = new Date(hist[0].timestamp); const last = new Date(hist[hist.length-1].timestamp);
      const toISODate = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().substring(0,10);
      fromDate.value = toISODate(first); toDate.value = toISODate(last);
      applyRange(hist);
      priceBody.classList.remove('d-none');
      statusPrice.innerHTML = '<div class="alert alert-success">Price data loaded.</div>';
    } catch (e) {
      statusPrice.innerHTML = `<div class=\"alert alert-danger\">${e.message || 'Unexpected error'}</div>`;
    }
  });

  btnApplyRange?.addEventListener('click', () => { if (lastScrape?.price_history) applyRange(lastScrape.price_history); });
  btnResetRange?.addEventListener('click', () => {
    if (!lastScrape?.price_history?.length) return;
    const hist = lastScrape.price_history; const first = new Date(hist[0].timestamp); const last = new Date(hist[hist.length-1].timestamp);
    const toISODate = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().substring(0,10);
    fromDate.value = toISODate(first); toDate.value = toISODate(last); applyRange(hist);
  });

  // ========== Verdict Composer ==========
  const inputMode = document.getElementById('inputMode');
  const customTextBox = document.getElementById('customTextBox');
  const customTexts = document.getElementById('customTexts');
  const weightSlider = document.getElementById('weightSlider');
  const threshSlider = document.getElementById('threshSlider');
  const wReviews = document.getElementById('wReviews');
  const wAspects = document.getElementById('wAspects');
  const btnCompose = document.getElementById('btnCompose');
  const btnSpeak = document.getElementById('btnSpeak');
  const composeStatus = document.getElementById('composeStatus');
  const composeResults = document.getElementById('composeResults');
  const cScore = document.getElementById('cScore');
  const cPros = document.getElementById('cPros');
  const cCons = document.getElementById('cCons');
  const cVerdict = document.getElementById('cVerdict');

  let mode = 'scraped';
  inputMode?.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-mode]'); if (!btn) return;
    inputMode.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    mode = btn.getAttribute('data-mode');
    customTextBox.classList.toggle('d-none', mode !== 'custom');
  });

  weightSlider?.addEventListener('input', () => { wReviews.textContent = weightSlider.value; wAspects.textContent = 100 - Number(weightSlider.value); });

  function buildProsCons(aspects, thresh) {
    const POS_TH = thresh/100; const NEG_TH = -POS_TH;
    const entries = Object.entries(aspects || {});
    const sortedDesc = entries.sort((a,b)=>b[1]-a[1]);
    const sortedAsc = [...sortedDesc].reverse();
    let pros = sortedDesc.filter(([_,s])=>s>=POS_TH).slice(0,2);
    let cons = sortedAsc.filter(([_,s])=>s<=NEG_TH).slice(0,2);
    if (pros.length<2) pros = sortedDesc.slice(0,2);
    if (cons.length<2) cons = sortedAsc.slice(0,2);
    return { pros, cons };
  }

  function composeVerdict(score, pros, cons) {
    let recommendation = score>=70? 'recommended' : score>=50? 'acceptable' : 'not recommended';
    let verdict = `This product is ${recommendation} with a score of ${Math.round(score)}%.`;
    if (pros?.length) verdict += ` Customers love the ${pros.map(p=>p[0]).join(', ')}.`;
    if (cons?.length) verdict += ` However, they complain about the ${cons.map(c=>c[0]).join(', ')}.`;
    return verdict;
  }

  btnCompose?.addEventListener('click', async () => {
    composeStatus.innerHTML = '<div class="alert alert-info">Composing...</div>';
    composeResults.classList.add('d-none');
    try {
      let texts = [];
      if (mode === 'scraped') {
        if (!lastScrape?.sample_reviews?.length) throw new Error('No scraped sample available. Use Aspect Explorer or Price Simulator first.');
        texts = lastScrape.sample_reviews;
      } else {
        texts = customTexts.value.split('\n').map(s=>s.trim()).filter(Boolean);
        if (!texts.length) throw new Error('Enter at least one line of custom text.');
      }
      const analysis = await analyzeTexts(texts);
      const os = analysis.overall_sentiment || {}; const aspects = analysis.aspect_sentiments || {};
      const total = (os.positive||0) + (os.negative||0) + (os.neutral||0);
      const posRatio = total ? (os.positive||0)/total : 0;
      const avgAspect = Object.values(aspects).length ? Object.values(aspects).reduce((a,b)=>a+b,0)/Object.values(aspects).length : 0;
      const normAspect = (avgAspect + 1)/2; // [-1,1] -> [0,1]
      const wRev = Number(weightSlider.value)/100; const wAsp = 1 - wRev;
      const score = (posRatio*wRev + normAspect*wAsp) * 100;
      const pc = buildProsCons(aspects, Number(threshSlider.value));

      cScore.textContent = Math.round(score);
      cPros.innerHTML = pc.pros.map(([a,s])=>`<li class=\"list-group-item\"><strong>${a}</strong> <span class=\"badge bg-success ms-2\">${s}</span></li>`).join('') || '<li class="list-group-item">—</li>';
      cCons.innerHTML = pc.cons.map(([a,s])=>`<li class=\"list-group-item\"><strong>${a}</strong> <span class=\"badge bg-danger ms-2\">${s}</span></li>`).join('') || '<li class="list-group-item">—</li>';
      const verdict = composeVerdict(score, pc.pros, pc.cons);
      cVerdict.textContent = verdict;
      composeResults.classList.remove('d-none');
      composeStatus.innerHTML = '';
    } catch (e) {
      composeStatus.innerHTML = `<div class=\"alert alert-danger\">${e.message || 'Unexpected error'}</div>`;
    }
  });

  btnSpeak?.addEventListener('click', () => {
    if (!('speechSynthesis' in window)) { alert('Speech synthesis not supported in this browser.'); return; }
    const text = document.getElementById('cVerdict').textContent.trim();
    if (!text) { alert('Compose a verdict first.'); return; }
    const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 1.0; u.pitch = 1.0; window.speechSynthesis.speak(u);
  });
})();
</script>
{% endblock %}
