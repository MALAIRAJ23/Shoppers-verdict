{% extends 'base.html' %}

{% block title %}AI Shopping Labs - Advanced Features{% endblock %}

{% block content %}
<section class="labs-hero text-center py-5">
  <div class="container">
    <h1 class="display-4 fw-bold text-white animate__animated animate__fadeInDown">üî¨ AI Shopping Labs</h1>
    <p class="lead text-white-75 mb-4 animate__animated animate__fadeInUp animate__delay-1s">Experiment with powerful AI tools that drive intelligent shopping decisions.</p>
    <div class="hero-stats animate__animated animate__fadeInUp animate__delay-2s">
      <div class="row justify-content-center">
        <div class="col-md-2 col-4">
          <div class="stat-card">
            <div class="stat-number" id="totalAnalyses">0</div>
            <div class="stat-label">Analyses</div>
          </div>
        </div>
        <div class="col-md-2 col-4">
          <div class="stat-card">
            <div class="stat-number">3</div>
            <div class="stat-label">AI Tools</div>
          </div>
        </div>
        <div class="col-md-2 col-4">
          <div class="stat-card">
            <div class="stat-number" id="avgAccuracy">87%</div>
            <div class="stat-label">Accuracy</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="container py-5">
  <div class="row g-4">
    <!-- Card 1: Aspect Explorer -->
    <div class="col-lg-4 mb-4">
      <div class="feature-card glass-card h-100" data-feature="aspects">
        <div class="card-inner">
          <div class="feature-icon">
            <i class="bi bi-compass"></i>
          </div>
          <h5 class="feature-title">üîç Aspect Explorer</h5>
          <p class="feature-description">Deep-dive into customer sentiment by product aspects. Identify what customers love and hate with AI-powered aspect extraction.</p>
          <div class="feature-stats">
            <div class="stat-item">
              <span class="stat-label">Accuracy:</span>
              <span class="stat-value">91%</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Speed:</span>
              <span class="stat-value">~2s</span>
            </div>
          </div>
          <button class="btn btn-lilac-gradient btn-sm w-100 mt-3">
            <i class="bi bi-play-fill me-2"></i>Launch Explorer
          </button>
        </div>
      </div>
    </div>

    <!-- Card 2: Price Intelligence Hub -->
    <div class="col-lg-4 mb-4">
      <div class="feature-card glass-card h-100" data-feature="price">
        <div class="card-inner">
          <div class="feature-icon">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
          <h5 class="feature-title">üìà Price Intelligence Hub</h5>
          <p class="feature-description">Advanced price tracking with trend analysis, volatility metrics, and smart alerts. Make data-driven purchase timing decisions.</p>
          <div class="feature-stats">
            <div class="stat-item">
              <span class="stat-label">Metrics:</span>
              <span class="stat-value">8+</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">History:</span>
              <span class="stat-value">Unlimited</span>
            </div>
          </div>
          <button class="btn btn-lilac-gradient btn-sm w-100 mt-3">
            <i class="bi bi-bar-chart-line me-2"></i>Analyze Prices
          </button>
        </div>
      </div>
    </div>

    <!-- Card 3: Smart Verdict Composer -->
    <div class="col-lg-4 mb-4">
      <div class="feature-card glass-card h-100" data-feature="verdict">
        <div class="card-inner">
          <div class="feature-icon">
            <i class="bi bi-magic"></i>
          </div>
          <h5 class="feature-title">üéØ Smart Verdict Composer</h5>
          <p class="feature-description">Customize AI decision-making with adjustable weights, thresholds, and personalized recommendation algorithms.</p>
          <div class="feature-stats">
            <div class="stat-item">
              <span class="stat-label">Customization:</span>
              <span class="stat-value">High</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Voice Output:</span>
              <span class="stat-value">Yes</span>
            </div>
          </div>
          <button class="btn btn-lilac-gradient btn-sm w-100 mt-3">
            <i class="bi bi-sliders me-2"></i>Compose Verdict
          </button>
        </div>
      </div>
    </div>
  </div>

  <hr class="my-5">

  <!-- Panels -->
  <div id="panel-aspects" class="card shadow-sm mb-4 d-none">
    <div class="card-header">Aspect Explorer</div>
    <div class="card-body">
      <label class="form-label">Product URL</label>
      <div class="input-group mb-3">
        <input id="urlAspects" type="url" class="form-control" placeholder="https://www.flipkart.com/... or https://www.amazon.in/...">
        <button id="btnFetchAspects" class="btn btn-primary">Fetch</button>
      </div>
      <div id="statusAspects"></div>
      <div id="aspectsBody" class="d-none">
        <div class="d-flex flex-wrap gap-2" id="aspectChips"></div>
        <div class="mt-3">
          <h6 class="mb-2">Supporting Sentences</h6>
          <ul id="aspectSentences" class="list-group small"></ul>
        </div>
      </div>
    </div>
  </div>

  <div id="panel-price" class="card shadow-sm mb-4 d-none">
    <div class="card-header">Price Insight Simulator</div>
    <div class="card-body">
      <label class="form-label">Product URL</label>
      <div class="input-group mb-3">
        <input id="urlPrice" type="url" class="form-control" placeholder="https://...">
        <button id="btnFetchPrice" class="btn btn-primary">Fetch</button>
      </div>
      <div id="statusPrice"></div>
      <div id="priceBody" class="d-none">
        <div class="row g-3 align-items-end">
          <div class="col-6">
            <label class="form-label small">From</label>
            <input id="fromDate" type="date" class="form-control form-control-sm">
          </div>
          <div class="col-6">
            <label class="form-label small">To</label>
            <input id="toDate" type="date" class="form-control form-control-sm">
          </div>
        </div>
        <div class="d-flex gap-2 mt-2">
          <button id="btnApplyRange" class="btn btn-outline-primary btn-sm">Apply Range</button>
          <button id="btnResetRange" class="btn btn-outline-secondary btn-sm">Reset</button>
        </div>
        <div class="row g-3 mt-3">
          <div class="col-6 col-md-3">
            <div class="metric">
              <div class="metric-label">Latest</div>
              <div class="metric-value" id="mLatest">‚Äî</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric">
              <div class="metric-label">Min</div>
              <div class="metric-value" id="mMin">‚Äî</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric">
              <div class="metric-label">Max</div>
              <div class="metric-value" id="mMax">‚Äî</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="metric">
              <div class="metric-label">Volatility</div>
              <div class="metric-value" id="mVol">‚Äî</div>
            </div>
          </div>
        </div>
        <canvas id="priceChartPreview" height="120" class="mt-3"></canvas>
      </div>
    </div>
  </div>

  <div id="panel-verdict" class="card shadow-sm mb-4 d-none">
    <div class="card-header">Verdict Composer</div>
    <div class="card-body">
      <ul class="nav nav-pills small" id="inputMode" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-mode="scraped" type="button">Use Last Scrape</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-mode="custom" type="button">Custom Text</button>
        </li>
      </ul>

      <div id="customTextBox" class="mt-3 d-none">
        <label class="form-label">Enter one review per line</label>
        <textarea id="customTexts" class="form-control" rows="5" placeholder="Great battery life...\nSpeakers are weak..."></textarea>
      </div>

      <div class="row mt-3 g-3">
        <div class="col-12">
          <label class="form-label">Review Weight vs Aspect Weight</label>
          <input type="range" id="weightSlider" class="form-range" min="0" max="100" step="5" value="70">
          <div class="d-flex justify-content-between small">
            <span>Reviews: <span id="wReviews">70</span>%</span>
            <span>Aspects: <span id="wAspects">30</span>%</span>
          </div>
        </div>
        <div class="col-12">
          <label class="form-label">Pros/Cons Threshold</label>
          <input type="range" id="threshSlider" class="form-range" min="0" max="20" step="1" value="5">
          <div class="small text-muted">Higher values demand stronger sentiment to qualify as a pro/cons.</div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-2">
        <button id="btnCompose" class="btn btn-primary">Compose Verdict</button>
        <button id="btnSpeak" class="btn btn-outline-primary"><i class="bi bi-volume-up"></i></button>
      </div>

      <div id="composeStatus" class="mt-3"></div>
      <div id="composeResults" class="mt-3 d-none">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Score</h6>
              <span class="badge bg-primary" id="cScore">‚Äî</span>
            </div>
            <hr>
            <div class="row">
              <div class="col-6">
                <h6>Pros</h6>
                <ul id="cPros" class="list-group list-group-flush small"></ul>
              </div>
              <div class="col-6">
                <h6>Cons</h6>
                <ul id="cCons" class="list-group list-group-flush small"></ul>
              </div>
            </div>
            <hr>
            <p class="mb-0 small text-muted">Verdict</p>
            <p id="cVerdict" class="mb-0"></p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

<style>
:root {
  /* Lilac Theme Variables */
  --primary-lilac: #b57edc;
  --primary-lilac-dark: #7a3db8;
  --primary-lilac-light: #d6b4fc;
  --lilac-gradient: linear-gradient(135deg, #b57edc 0%, #7a3db8 100%);
  --lilac-gradient-alt: linear-gradient(135deg, #a66dd4, #6a1b9a);
  --text-lilac: #6a1b9a;
  --bg-lilac-light: rgba(181, 126, 220, 0.1);
  --shadow-lilac: rgba(106, 27, 154, 0.2);
}

/* Enhanced Hero */
.labs-hero { 
  background: radial-gradient(1200px 600px at 50% -20%, rgba(181,126,220,0.3), transparent), 
             linear-gradient(135deg, #2d1b4e, #1a0d2e); 
  position: relative;
  overflow: hidden;
}

.labs-hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
  opacity: 0.3;
}

.text-white-75 { color: rgba(255, 255, 255, 0.85) !important; }

/* Hero Stats */
.hero-stats {
  margin-top: 2rem;
}

.stat-card {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  padding: 1rem 0.5rem;
  transition: all 0.3s ease;
}

.stat-card:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
}

.stat-number {
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--primary-lilac-light);
  display: block;
  line-height: 1;
}

.stat-label {
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.7);
  margin-top: 0.25rem;
}

/* Enhanced Glass Cards */
.glass-card { 
  position: relative; 
  border-radius: 20px; 
  background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)); 
  backdrop-filter: blur(15px); 
  border: 1px solid rgba(255,255,255,0.2); 
  box-shadow: 0 15px 35px var(--shadow-lilac); 
  overflow: hidden; 
  transition: transform 0.4s ease, box-shadow 0.4s ease; 
  cursor: pointer;
}

.glass-card:hover { 
  transform: translateY(-8px) scale(1.02); 
  box-shadow: 0 25px 50px rgba(106, 27, 154, 0.3); 
}

.glass-card .card-inner { 
  padding: 2rem 1.5rem; 
  position: relative;
  z-index: 2;
}

/* Feature Card Enhancements */
.feature-icon {
  width: 60px;
  height: 60px;
  background: var(--lilac-gradient);
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 1rem;
  box-shadow: 0 8px 20px rgba(106, 27, 154, 0.3);
}

.feature-icon i {
  font-size: 1.5rem;
  color: white;
}

.feature-title {
  color: var(--text-lilac);
  font-weight: 700;
  font-size: 1.2rem;
  margin-bottom: 1rem;
}

.feature-description {
  color: #555;
  font-size: 0.9rem;
  line-height: 1.5;
  margin-bottom: 1.5rem;
}

.feature-stats {
  display: flex;
  justify-content: space-between;
  margin-bottom: 1rem;
}

.stat-item {
  text-align: center;
  flex: 1;
}

.stat-label {
  font-size: 0.7rem;
  color: #888;
  display: block;
}

.stat-value {
  font-weight: 700;
  color: var(--primary-lilac-dark);
  font-size: 0.9rem;
  display: block;
  margin-top: 0.2rem;
}

/* Lilac Gradient Button */
.btn-lilac-gradient {
  background: var(--lilac-gradient);
  border: none;
  color: white;
  font-weight: 600;
  border-radius: 25px;
  padding: 0.6rem 1.2rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(106, 27, 154, 0.3);
}

.btn-lilac-gradient:hover {
  background: var(--lilac-gradient-alt);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(106, 27, 154, 0.4);
  color: white;
}

/* Enhanced Panels */
.card {
  border: none;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(106, 27, 154, 0.15);
  overflow: hidden;
}

.card-header {
  background: var(--lilac-gradient);
  color: white;
  font-weight: 700;
  font-size: 1.1rem;
  padding: 1rem 1.5rem;
  border: none;
}

.card-body {
  padding: 2rem;
  background: rgba(255, 255, 255, 0.95);
}

/* Enhanced Metrics */
.metric { 
  background: var(--bg-lilac-light); 
  border: 1px solid rgba(181, 126, 220, 0.2); 
  border-radius: 12px; 
  padding: 0.75rem 1rem;
  transition: all 0.3s ease;
}

.metric:hover {
  background: rgba(181, 126, 220, 0.15);
  transform: translateY(-1px);
}

.metric-label { 
  font-size: 0.75rem; 
  color: var(--text-lilac); 
  font-weight: 600;
}

.metric-value { 
  font-weight: 800; 
  color: var(--primary-lilac-dark);
  font-size: 1.1rem;
}

/* Enhanced Aspect Chips */
.aspect-chip { 
  border-radius: 25px; 
  padding: 0.5rem 1rem; 
  color: #fff; 
  font-weight: 600; 
  cursor: pointer; 
  user-select: none; 
  transition: all 0.3s ease;
  margin: 0.25rem;
  display: inline-block;
  border: 2px solid transparent;
}

.aspect-chip:hover { 
  transform: translateY(-2px) scale(1.05); 
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  border-color: rgba(255, 255, 255, 0.3);
}

/* Form Enhancements */
.form-control {
  border-radius: 10px;
  border: 2px solid rgba(181, 126, 220, 0.2);
  padding: 0.75rem 1rem;
  transition: all 0.3s ease;
}

.form-control:focus {
  border-color: var(--primary-lilac);
  box-shadow: 0 0 0 0.2rem rgba(181, 126, 220, 0.25);
}

.btn-primary {
  background: var(--lilac-gradient);
  border: none;
  border-radius: 10px;
  font-weight: 600;
  padding: 0.75rem 1.5rem;
}

.btn-primary:hover {
  background: var(--lilac-gradient-alt);
  transform: translateY(-1px);
}

/* Loading States */
.loading {
  position: relative;
  overflow: hidden;
}

.loading::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(181, 126, 220, 0.4), transparent);
  animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Responsive Design */
@media (max-width: 768px) {
  .hero-stats .col-4 {
    margin-bottom: 1rem;
  }
  
  .feature-stats {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .stat-item {
    text-align: left;
  }
}
</style>

<script>
(() => {
  // Initialize page with animations and interactions
  document.addEventListener('DOMContentLoaded', () => {
    initializeStats();
    setupFeatureCardListeners();
    addLoadingStates();
  });

  // Initialize animated statistics
  function initializeStats() {
    const totalAnalysesEl = document.getElementById('totalAnalyses');
    if (totalAnalysesEl) {
      animateNumber(totalAnalysesEl, 0, 1247, 2000);
    }
  }

  // Animate number counter
  function animateNumber(element, start, end, duration) {
    const startTime = performance.now();
    const range = end - start;
    
    function updateNumber(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const current = Math.floor(start + (range * easeOutQuart(progress)));
      
      element.textContent = current.toLocaleString();
      
      if (progress < 1) {
        requestAnimationFrame(updateNumber);
      }
    }
    
    requestAnimationFrame(updateNumber);
  }

  // Easing function for smooth animation
  function easeOutQuart(t) {
    return 1 - (--t) * t * t * t;
  }

  // Setup click listeners for feature cards
  function setupFeatureCardListeners() {
    document.querySelectorAll('.feature-card[data-feature]').forEach(card => {
      const button = card.querySelector('.btn-lilac-gradient');
      const feature = card.getAttribute('data-feature');
      
      const clickHandler = (e) => {
        e.preventDefault();
        showPanel(feature);
        
        // Add click animation
        card.style.transform = 'scale(0.95)';
        setTimeout(() => {
          card.style.transform = '';
        }, 150);
      };
      
      card.addEventListener('click', clickHandler);
      button?.addEventListener('click', clickHandler);
    });
  }

  // Add loading state helpers
  function addLoadingStates() {
    window.setLoadingState = function(element, isLoading) {
      if (isLoading) {
        element.classList.add('loading');
        element.style.pointerEvents = 'none';
      } else {
        element.classList.remove('loading');
        element.style.pointerEvents = '';
      }
    };
  }

  // Utility: show exactly one panel, scroll to it with enhanced animation
  function showPanel(key) {
    const id = key === 'aspects' ? '#panel-aspects' : key === 'price' ? '#panel-price' : key === 'verdict' ? '#panel-verdict' : null;
    if (!id) return;
    
    // Hide all panels with fade out
    document.querySelectorAll('#panel-aspects, #panel-price, #panel-verdict').forEach(el => {
      if (!el.classList.contains('d-none')) {
        el.style.opacity = '0';
        setTimeout(() => el.classList.add('d-none'), 150);
      }
    });
    
    // Show selected panel with fade in
    setTimeout(() => {
      const panel = document.querySelector(id);
      panel.classList.remove('d-none');
      panel.style.opacity = '0';
      
      setTimeout(() => {
        panel.style.opacity = '1';
        panel.style.transition = 'opacity 0.3s ease';
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 50);
    }, 200);
  }

  // Open requested panel based on URL param
  const params = new URLSearchParams(window.location.search);
  const open = params.get('open');
  if (open) {
    setTimeout(() => showPanel(open), 500); // Delay for page load
  }

  // Shared state
  let lastScrape = null; // { sample_reviews, price_history, reviews_count }

  // Helpers
  const colorForSent = (v) => {
    const clamped = Math.max(-1, Math.min(1, v || 0));
    const hue = (clamped + 1) * 60; // -1->0 red, 0->60 yellow, 1->120 green
    return `hsl(${hue}, 85%, 45%)`;
  };
  const toSentences = (text) => text.split(/(?<=[.!?])\s+/g).map(s => s.trim()).filter(Boolean);

  async function fetchPreview(url) {
    const res = await fetch('/api/scrape_preview', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'Scrape failed');
    lastScrape = { sample_reviews: data.sample_reviews || [], price_history: data.price_history || [], reviews_count: data.reviews_count || 0 };
    return lastScrape;
  }

  async function analyzeTexts(texts) {
    const res = await fetch('/api/analyze_text', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ texts }) });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'Analysis failed');
    return data.analysis || { overall_sentiment: {}, aspect_sentiments: {} };
  }

  // ========== Aspect Explorer ==========
  const urlAspects = document.getElementById('urlAspects');
  const btnFetchAspects = document.getElementById('btnFetchAspects');
  const statusAspects = document.getElementById('statusAspects');
  const aspectChips = document.getElementById('aspectChips');
  const aspectSentences = document.getElementById('aspectSentences');
  const aspectsBody = document.getElementById('aspectsBody');

  btnFetchAspects?.addEventListener('click', async () => {
    // Enhanced loading state
    setLoadingState(btnFetchAspects, true);
    statusAspects.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split me-2"></i>Fetching and analyzing reviews...</div>';
    aspectChips.innerHTML = '';
    aspectSentences.innerHTML = '';
    aspectsBody.classList.add('d-none');
    
    try {
      const url = urlAspects.value.trim();
      if (!url) throw new Error('Please enter a valid product URL');
      
      // Validate URL format
      if (!url.match(/^https?:\/\/(www\.)?(flipkart|amazon)\.(com|in)\//)) {
        throw new Error('Please enter a valid Flipkart or Amazon URL');
      }
      
      statusAspects.innerHTML = '<div class="alert alert-info"><i class="bi bi-download me-2"></i>Scraping product reviews...</div>';
      const preview = await fetchPreview(url);
      
      if (!preview.sample_reviews || preview.sample_reviews.length === 0) {
        throw new Error('No reviews found for this product. It may be too new or have no reviews yet.');
      }
      
      statusAspects.innerHTML = '<div class="alert alert-info"><i class="bi bi-cpu me-2"></i>Analyzing sentiment and extracting aspects...</div>';
      const analysis = await analyzeTexts(preview.sample_reviews);
      const aspects = analysis.aspect_sentiments || {};
      const sorted = Object.entries(aspects).sort((a,b) => Math.abs(b[1]) - Math.abs(a[1]));
      
      if (sorted.length === 0) {
        statusAspects.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>No distinct aspects identified from the reviews. The text may be too short or generic.</div>';
        return;
      }
      
      // Build enhanced chips with tooltips
      sorted.forEach(([aspect, score], index) => {
        const chip = document.createElement('span');
        chip.className = 'aspect-chip';
        chip.style.background = colorForSent(score);
        chip.innerHTML = `<strong>${aspect}</strong> <small>(${score > 0 ? '+' : ''}${score.toFixed(2)})</small>`;
        chip.title = `Sentiment score: ${score.toFixed(2)} (${score > 0.3 ? 'Very Positive' : score > 0.1 ? 'Positive' : score > -0.1 ? 'Neutral' : score > -0.3 ? 'Negative' : 'Very Negative'})`;
        
        chip.addEventListener('click', () => {
          // Remove active state from other chips
          document.querySelectorAll('.aspect-chip').forEach(c => c.style.border = '2px solid transparent');
          chip.style.border = '2px solid rgba(255, 255, 255, 0.8)';
          
          const sents = (preview.sample_reviews || []).flatMap(toSentences);
          const lower = aspect.toLowerCase();
          const matches = sents.filter(s => s.toLowerCase().includes(lower)).slice(0, 8);
          
          aspectSentences.innerHTML = matches.length > 0 
            ? `<div class="mb-2"><strong>Supporting sentences for "${aspect}":</strong></div>` + 
              matches.map(s => `<li class="list-group-item">${s}</li>`).join('')
            : '<li class="list-group-item text-muted"><i class="bi bi-info-circle me-2"></i>No supporting sentences found for this aspect.</li>';
        });
        
        aspectChips.appendChild(chip);
        
        // Auto-select first (strongest) aspect
        if (index === 0) {
          setTimeout(() => chip.click(), 300);
        }
      });
      
      aspectsBody.classList.remove('d-none');
      statusAspects.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>Successfully analyzed <strong>${preview.reviews_count}</strong> reviews (sampled ${preview.sample_reviews.length}). Found <strong>${sorted.length}</strong> key aspects. Click any chip to see supporting sentences.</div>`;
      
    } catch (e) {
      statusAspects.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-circle me-2"></i><strong>Analysis Failed:</strong> ${e.message || 'An unexpected error occurred. Please try again.'}</div>`;
    } finally {
      setLoadingState(btnFetchAspects, false);
    }
  });

  // ========== Price Insight Simulator ==========
  const urlPrice = document.getElementById('urlPrice');
  const btnFetchPrice = document.getElementById('btnFetchPrice');
  const statusPrice = document.getElementById('statusPrice');
  const priceBody = document.getElementById('priceBody');
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const btnApplyRange = document.getElementById('btnApplyRange');
  const btnResetRange = document.getElementById('btnResetRange');
  const mLatest = document.getElementById('mLatest');
  const mMin = document.getElementById('mMin');
  const mMax = document.getElementById('mMax');
  const mVol = document.getElementById('mVol');
  let priceChart;

  function computeMetrics(series) {
    if (!series.length) return { latest: '‚Äî', min: '‚Äî', max: '‚Äî', vol: '‚Äî' };
    const prices = series.map(p => p.price);
    const latest = series[series.length - 1].price;
    const min = Math.min(...prices), max = Math.max(...prices);
    const mean = prices.reduce((a,b)=>a+b,0)/prices.length;
    const variance = prices.reduce((a,b)=>a+Math.pow(b-mean,2),0)/prices.length;
    const std = Math.sqrt(variance);
    const vol = mean ? (std/mean*100).toFixed(2) + '%' : '‚Äî';
    return { latest, min, max, vol };
  }

  function drawPriceChart(series) {
    const ctx = document.getElementById('priceChartPreview').getContext('2d');
    if (priceChart) priceChart.destroy();
    priceChart = new Chart(ctx, {
      type: 'line',
      data: { labels: series.map(s => s.timestamp), datasets: [{ label: 'Price', data: series.map(s => s.price), borderColor: '#20c997', backgroundColor: 'transparent', tension: 0.15 }] },
      options: { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { title: { display: true, text: 'Price' } } } }
    });
  }

  function applyRange(series) {
    const from = fromDate.value ? new Date(fromDate.value) : null;
    const to = toDate.value ? new Date(toDate.value) : null;
    const filtered = series.filter(p => { const d = new Date(p.timestamp); if (from && d < from) return false; if (to && d > to) return false; return true; });
    const m = computeMetrics(filtered);
    mLatest.textContent = m.latest; mMin.textContent = m.min; mMax.textContent = m.max; mVol.textContent = m.vol;
    drawPriceChart(filtered);
  }

  btnFetchPrice?.addEventListener('click', async () => {
    statusPrice.innerHTML = '<div class="alert alert-info">Fetching price history...</div>';
    priceBody.classList.add('d-none');
    try {
      const url = urlPrice.value.trim();
      if (!url) throw new Error('Please enter a product URL');
      const preview = await fetchPreview(url);
      const hist = preview.price_history || [];
      if (!hist.length) { statusPrice.innerHTML = '<div class="alert alert-warning">No price history available yet. Trigger analysis a few times to build history.</div>'; return; }
      const first = new Date(hist[0].timestamp); const last = new Date(hist[hist.length-1].timestamp);
      const toISODate = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().substring(0,10);
      fromDate.value = toISODate(first); toDate.value = toISODate(last);
      applyRange(hist);
      priceBody.classList.remove('d-none');
      statusPrice.innerHTML = '<div class="alert alert-success">Price data loaded.</div>';
    } catch (e) {
      statusPrice.innerHTML = `<div class=\"alert alert-danger\">${e.message || 'Unexpected error'}</div>`;
    }
  });

  btnApplyRange?.addEventListener('click', () => { if (lastScrape?.price_history) applyRange(lastScrape.price_history); });
  btnResetRange?.addEventListener('click', () => {
    if (!lastScrape?.price_history?.length) return;
    const hist = lastScrape.price_history; const first = new Date(hist[0].timestamp); const last = new Date(hist[hist.length-1].timestamp);
    const toISODate = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().substring(0,10);
    fromDate.value = toISODate(first); toDate.value = toISODate(last); applyRange(hist);
  });

  // ========== Verdict Composer ==========
  const inputMode = document.getElementById('inputMode');
  const customTextBox = document.getElementById('customTextBox');
  const customTexts = document.getElementById('customTexts');
  const weightSlider = document.getElementById('weightSlider');
  const threshSlider = document.getElementById('threshSlider');
  const wReviews = document.getElementById('wReviews');
  const wAspects = document.getElementById('wAspects');
  const btnCompose = document.getElementById('btnCompose');
  const btnSpeak = document.getElementById('btnSpeak');
  const composeStatus = document.getElementById('composeStatus');
  const composeResults = document.getElementById('composeResults');
  const cScore = document.getElementById('cScore');
  const cPros = document.getElementById('cPros');
  const cCons = document.getElementById('cCons');
  const cVerdict = document.getElementById('cVerdict');

  let mode = 'scraped';
  inputMode?.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-mode]'); if (!btn) return;
    inputMode.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    mode = btn.getAttribute('data-mode');
    customTextBox.classList.toggle('d-none', mode !== 'custom');
  });

  weightSlider?.addEventListener('input', () => { wReviews.textContent = weightSlider.value; wAspects.textContent = 100 - Number(weightSlider.value); });

  function buildProsCons(aspects, thresh) {
    const POS_TH = thresh/100; const NEG_TH = -POS_TH;
    const entries = Object.entries(aspects || {});
    const sortedDesc = entries.sort((a,b)=>b[1]-a[1]);
    const sortedAsc = [...sortedDesc].reverse();
    let pros = sortedDesc.filter(([_,s])=>s>=POS_TH).slice(0,2);
    let cons = sortedAsc.filter(([_,s])=>s<=NEG_TH).slice(0,2);
    if (pros.length<2) pros = sortedDesc.slice(0,2);
    if (cons.length<2) cons = sortedAsc.slice(0,2);
    return { pros, cons };
  }

  function composeVerdict(score, pros, cons) {
    let recommendation = score>=70? 'recommended' : score>=50? 'acceptable' : 'not recommended';
    let verdict = `This product is ${recommendation} with a score of ${Math.round(score)}%.`;
    if (pros?.length) verdict += ` Customers love the ${pros.map(p=>p[0]).join(', ')}.`;
    if (cons?.length) verdict += ` However, they complain about the ${cons.map(c=>c[0]).join(', ')}.`;
    return verdict;
  }

  btnCompose?.addEventListener('click', async () => {
    composeStatus.innerHTML = '<div class="alert alert-info">Composing...</div>';
    composeResults.classList.add('d-none');
    try {
      let texts = [];
      if (mode === 'scraped') {
        if (!lastScrape?.sample_reviews?.length) throw new Error('No scraped sample available. Use Aspect Explorer or Price Simulator first.');
        texts = lastScrape.sample_reviews;
      } else {
        texts = customTexts.value.split('\n').map(s=>s.trim()).filter(Boolean);
        if (!texts.length) throw new Error('Enter at least one line of custom text.');
      }
      const analysis = await analyzeTexts(texts);
      const os = analysis.overall_sentiment || {}; const aspects = analysis.aspect_sentiments || {};
      const total = (os.positive||0) + (os.negative||0) + (os.neutral||0);
      const posRatio = total ? (os.positive||0)/total : 0;
      const avgAspect = Object.values(aspects).length ? Object.values(aspects).reduce((a,b)=>a+b,0)/Object.values(aspects).length : 0;
      const normAspect = (avgAspect + 1)/2; // [-1,1] -> [0,1]
      const wRev = Number(weightSlider.value)/100; const wAsp = 1 - wRev;
      const score = (posRatio*wRev + normAspect*wAsp) * 100;
      const pc = buildProsCons(aspects, Number(threshSlider.value));

      cScore.textContent = Math.round(score);
      cPros.innerHTML = pc.pros.map(([a,s])=>`<li class=\"list-group-item\"><strong>${a}</strong> <span class=\"badge bg-success ms-2\">${s}</span></li>`).join('') || '<li class="list-group-item">‚Äî</li>';
      cCons.innerHTML = pc.cons.map(([a,s])=>`<li class=\"list-group-item\"><strong>${a}</strong> <span class=\"badge bg-danger ms-2\">${s}</span></li>`).join('') || '<li class="list-group-item">‚Äî</li>';
      const verdict = composeVerdict(score, pc.pros, pc.cons);
      cVerdict.textContent = verdict;
      composeResults.classList.remove('d-none');
      composeStatus.innerHTML = '';
    } catch (e) {
      composeStatus.innerHTML = `<div class=\"alert alert-danger\">${e.message || 'Unexpected error'}</div>`;
    }
  });

  btnSpeak?.addEventListener('click', () => {
    if (!('speechSynthesis' in window)) { alert('Speech synthesis not supported in this browser.'); return; }
    const text = document.getElementById('cVerdict').textContent.trim();
    if (!text) { alert('Compose a verdict first.'); return; }
    const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 1.0; u.pitch = 1.0; window.speechSynthesis.speak(u);
  });
})();
</script>
{% endblock %}
